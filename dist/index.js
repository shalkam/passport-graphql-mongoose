!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r(require("util"),require("crypto")):"function"==typeof define&&define.amd?define("passport-local-mongoose",["util","crypto"],r):"object"==typeof exports?exports["passport-local-mongoose"]=r(require("util"),require("crypto")):e["passport-local-mongoose"]=r(e.util,e.crypto)}(this,function(e,r){return function(e){function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}var t={};return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=11)}([function(e,r){e.exports=require("util")},function(e,r,t){var s=t(5);r=e.exports=s,r.Strategy=s},function(e,r,t){"use strict";e.exports=t(9)},function(e,r,t){var s=t(4),n=s("AuthenticationError");e.exports={AuthenticationError:n,IncorrectUsernameError:s("IncorrectUsernameError",null,{inherits:n}),IncorrectPasswordError:s("IncorrectPasswordError",null,{inherits:n}),MissingUsernameError:s("MissingUsernameError",null,{inherits:n}),MissingPasswordError:s("MissingPasswordError",null,{inherits:n}),UserExistsError:s("UserExistsError",null,{inherits:n}),NoSaltValueStoredError:s("NoSaltValueStoredError",null,{inherits:n}),AttemptTooSoonError:s("AttemptTooSoonError",null,{inherits:n}),TooManyAttemptsError:s("TooManyAttemptsError",null,{inherits:n})}},function(e,r,t){function s(e,r){if(e)for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}var n=t(0);e.exports=function(e,r,t){t=t||{},t.captureStackTrace=void 0===t.captureStackTrace,t.inherits=t.inherits||Error;var o=function(){if(!(this instanceof o)){var i=Array.prototype.slice.call(arguments);return i.unshift(o),new(o.bind.apply(o,i))}t.inherits.call(this),t.captureStackTrace&&Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),s(r,this);var a=arguments[0];if(a){var u=Array.prototype.slice.call(arguments);if(u.length>1&&"object"==typeof u[u.length-1]){var l=u.pop();s(l,this)}this.message=n.format.apply(n,u)}this.name=e};return n.inherits(o,t.inherits),o}},function(e,r,t){function s(e,r){if("function"==typeof e&&(r=e,e={}),!r)throw new TypeError("LocalStrategy requires a verify callback");this._usernameField=e.usernameField||"username",this._passwordField=e.passwordField||"password",n.Strategy.call(this),this.name="local",this._verify=r,this._passReqToCallback=e.passReqToCallback}var n=t(7),o=t(0),i=t(6).lookup;o.inherits(s,n.Strategy),s.prototype.authenticate=function(e,r){function t(e,r,t){return e?o.error(e):r?void o.success(r,t):o.fail(t)}r=r||{};var s=i(e.body,this._usernameField)||i(e.query,this._usernameField),n=i(e.body,this._passwordField)||i(e.query,this._passwordField);if(!s||!n)return this.fail({message:r.badRequestMessage||"Missing credentials"},400);var o=this;try{o._passReqToCallback?this._verify(e,s,n,t):this._verify(s,n,t)}catch(e){return o.error(e)}},e.exports=s},function(e,r){r.lookup=function(e,r){if(!e)return null;for(var t=r.split("]").join("").split("["),s=0,n=t.length;s<n;s++){var o=e[t[s]];if("undefined"==typeof o)return null;if("object"!=typeof o)return o;e=o}return null}},function(e,r,t){var s=t(8);r=e.exports=s,r.Strategy=s},function(e,r){function t(){}t.prototype.authenticate=function(e,r){throw new Error("Strategy#authenticate must be overridden by subclass")},e.exports=t},function(e,r,t){"use strict";var s=t(10),n=1e4,o=function(e){return{hash:function(r,t){if(void 0===t&&r instanceof Function&&(t=r,r=void 0),!e)return t("No password provided");"string"==typeof r&&(r=new Buffer(r,"hex"));var o=function(){s.pbkdf2(e,r,n,64,"sha1",function(e,s){if(e)return t(e);var o="pbkdf2$"+n+"$"+s.toString("hex")+"$"+r.toString("hex");t(null,o)})};r?o():s.randomBytes(64,function(e,s){return e?t(e):(r=s,void o())})},verifyAgainst:function(r,t){if(!r||!e)return t(null,!1);var s=r.split("$");return 4===s.length&&s[2]&&s[3]?"pbkdf2"!==s[0]||s[1]!==n.toString()?t("Wrong algorithm and/or iterations"):void this.hash(s[3],function(e,s){return e?t(e):void t(null,s===r)}):t("Hash not formatted correctly")}}};e.exports=o},function(e,r){e.exports=require("crypto")},function(e,r,t){var s=t(1).Strategy,n=t(3),o=t(2);e.exports=function(e,r){function t(e,t){return new Promise(function(s,i){if(r.limitAttempts){var a=Math.pow(r.interval,Math.log(e.get(r.attemptsField)+1)),u=a<r.maxInterval?a:r.maxInterval;Date.now()-e.get(r.lastLoginField)<u&&(e.set(r.lastLoginField,Date.now()),e.save(),i(new n.AttemptTooSoonError(r.errorMessages.AttemptTooSoonError))),e.get(r.attemptsField)>=r.maxAttempts&&i(new n.TooManyAttemptsError(r.errorMessages.TooManyAttemptsError))}e.get(r.hashSaltField)||i(new n.NoSaltValueStoredError(r.errorMessages.NoSaltValueStoredError)),o(t).verifyAgainst(e.get(r.hashSaltField),function(t,o){t&&i(new Error("Something went wrong!")),o?(r.limitAttempts&&(e.set(r.lastLoginField,Date.now()),e.set(r.attemptsField,0),e.save()),s(e)):r.limitAttempts?(e.set(r.lastLoginField,Date.now()),e.set(r.attemptsField,e.get(r.attemptsField)+1),e.save(function(t){t&&i(t),i(e.get(r.attemptsField)>=r.maxAttempts?new n.TooManyAttemptsError(r.errorMessages.TooManyAttemptsError):new n.IncorrectPasswordError(r.errorMessages.IncorrectPasswordError))})):i(new n.IncorrectPasswordError(r.errorMessages.IncorrectPasswordError))})})}r=r||{},r.saltlen=r.saltlen||32,r.iterations=r.iterations||25e3,r.keylen=r.keylen||512,r.encoding=r.encoding||"hex",r.digestAlgorithm=r.digestAlgorithm||"sha256",r.passwordValidator=r.passwordValidator||function(e,r){r(null)},r.usernameField=r.usernameField||"username",r.usernameUnique=void 0===r.usernameUnique||r.usernameUnique,r.usernameQueryFields?r.usernameQueryFields.push(r.usernameField):r.usernameQueryFields=[r.usernameField],r.usernameLowerCase=r.usernameLowerCase||!1,r.hashSaltField=r.hashSaltField||"hashSalt",r.limitAttempts&&(r.lastLoginField=r.lastLoginField||"last",r.attemptsField=r.attemptsField||"attempts",r.interval=r.interval||100,r.maxInterval=r.maxInterval||3e5,r.maxAttempts=r.maxAttempts||1/0),r.errorMessages=r.errorMessages||{},r.errorMessages.MissingPasswordError=r.errorMessages.MissingPasswordError||"No password was given",r.errorMessages.AttemptTooSoonError=r.errorMessages.AttemptTooSoonError||"Account is currently locked. Try again later",r.errorMessages.TooManyAttemptsError=r.errorMessages.TooManyAttemptsError||"Account locked due to too many failed login attempts",r.errorMessages.NoSaltValueStoredError=r.errorMessages.NoSaltValueStoredError||"Authentication not possible. No salt value stored",r.errorMessages.IncorrectPasswordError=r.errorMessages.IncorrectPasswordError||"Password or username are incorrect",r.errorMessages.IncorrectUsernameError=r.errorMessages.IncorrectUsernameError||"Password or username are incorrect",r.errorMessages.MissingUsernameError=r.errorMessages.MissingUsernameError||"No username was given",r.errorMessages.UserExistsError=r.errorMessages.UserExistsError||"A user with the given username is already registered";var i={};e.path(r.usernameField)||(i[r.usernameField]={type:String,unique:r.usernameUnique}),i[r.hashSaltField]={type:String,select:!1},r.limitAttempts&&(i[r.attemptsField]={type:Number,default:0},i[r.lastLoginField]={type:Date,default:Date.now}),e.add(i),e.pre("save",function(e){r.usernameLowerCase&&this[r.usernameField]&&(this[r.usernameField]=this[r.usernameField].toLowerCase()),e()}),e.methods.setPassword=function(e,t){e||t(new n.MissingPasswordError(r.errorMessages.MissingPasswordError));var s=this;r.passwordValidator(e,function(n){return n?t(n):void o(e).hash(function(e,n){e&&t(new Error("Something went wrong!")),s.set(r.hashSaltField,n),t(null,s)})})},e.methods.authenticate=function(e){var s=this;return s.get(r.hashSaltField)?t(s,e):s.constructor.findByUsername(s.get(r.usernameField),!0).then(function(s){return s?t(s,e):new Promise(function(e,t){s||t(new n.IncorrectUsernameError(r.errorMessages.IncorrectUsernameError))})}).catch(function(e){if(e)return new Promise(function(r,t){t(e)})})},r.limitAttempts&&(e.methods.resetAttempts=function(e){this.set(r.attemptsField,0),this.save(e)}),e.statics.authenticate=function(){var e=this,t=function(t,s){return e.findByUsername(t,!0).then(function(e){return e?e.authenticate(s):new Promise(function(e,t){t(new n.IncorrectUsernameError(r.errorMessages.IncorrectUsernameError))})}).catch(function(e){return new Promise(function(r,t){e&&t(e)})})};return t},e.statics.serializeUser=function(){return function(e,t){t(null,e.get(r.usernameField))}},e.statics.deserializeUser=function(){var e=this;return function(r,t){e.findByUsername(r).then(function(e){t(null,e)})}},e.statics.register=function(e,t){if(e instanceof this||(e=new this(e)),!e.get(r.usernameField))return new Promise(function(e,t){t(new n.MissingUsernameError(r.errorMessages.MissingUsernameError))});var s=this;return s.findByUsername(e.get(r.usernameField)).then(function(s){return new Promise(function(o,i){s?i(new n.UserExistsError(r.errorMessages.UserExistsError)):e.setPassword(t,function(e,r){e&&i(e),o(r.save())})})}).catch(function(e){return new Promise(function(r,t){e&&t(e)})})},e.statics.findByUsername=function(e,t){void 0!==e&&r.usernameLowerCase&&(e=e.toLowerCase());for(var s=[],n=0;n<r.usernameQueryFields.length;n++){var o={};o[r.usernameQueryFields[n]]=e,s.push(o)}var i=this.findOne({$or:s});return t&&i.select("+"+r.hashSaltField),r.selectFields&&i.select(r.selectFields),r.populateFields&&i.populate(r.populateFields),i.exec()},e.statics.createStrategy=function(){return new s(r,this.authenticate())}},e.exports.errors=n}])});